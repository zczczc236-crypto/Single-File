<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mythic Overlord: GOD EDITION</title>
    <style>
        :root {
            --ssr: #ffcc00; --sr: #c154ff; --r: #00d2ff; --mythic: #ff4757;
            --gold: #ffd700; --dia: #00f2ff; --bg: #05050a;
        }

        body { margin: 0; background: var(--bg); color: white; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; height: 100vh; overflow: hidden; user-select: none; }
        #app { width: 100%; max-width: 480px; display: flex; flex-direction: column; background: radial-gradient(circle at top, #1a1a2e 0%, #05050a 100%); position: relative; height: 100%; box-shadow: 0 0 50px rgba(0,242,255,0.3); border: 1px solid #222; }

        /* ìƒíƒœë°” */
        .status-bar { padding: 15px; background: rgba(0,0,0,0.9); display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; border-bottom: 2px solid #333; flex-shrink: 0; z-index: 100; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-align: center; border: 1px solid #444; }

        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 110px; scrollbar-width: none; }
        .content::-webkit-scrollbar { display: none; }

        /* ì „íˆ¬ ì„¹ì…˜ */
        .battle-view { background: rgba(255,255,255,0.03); border: 2px solid #444; border-radius: 24px; padding: 20px; text-align: center; margin-bottom: 20px; position: relative; overflow: hidden; }
        .king-mode { border-color: var(--gold); box-shadow: 0 0 30px var(--gold); }
        .monster-img { font-size: 5rem; height: 140px; display: flex; align-items: center; justify-content: center; transition: 0.1s; filter: drop-shadow(0 0 15px rgba(255,255,255,0.2)); }
        .hp-bar { height: 16px; background: #222; border-radius: 8px; overflow: hidden; border: 1px solid #555; margin: 15px 0; position: relative; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #ff4757, #ff6b81); width: 100%; transition: 0.1s; }
        .hp-text { position: absolute; width: 100%; text-align: center; font-size: 0.6rem; line-height: 16px; font-weight: bold; top: 0; }

        /* ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { display: flex; align-items: center; background: rgba(255,255,255,0.06); margin-bottom: 12px; padding: 14px; border-radius: 18px; border: 1px solid #333; transition: 0.2s; }
        .card:active { transform: scale(0.98); }
        .card-img { width: 55px; height: 55px; background: #222; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-right: 15px; border: 2px solid #444; }
        .card-info { flex: 1; }

        /* ë„ê° ìŠ¤íƒ€ì¼ */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .book-slot { aspect-ratio: 1; background: #111; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; border: 1px solid #222; filter: grayscale(1); opacity: 0.2; transition: 0.5s; }
        .book-slot.active { filter: grayscale(0); opacity: 1; border-color: var(--ssr); box-shadow: 0 0 10px rgba(255,204,0,0.3); }

        /* í•˜ë‹¨ ë„¤ë¹„ */
        .nav { position: absolute; bottom: 0; width: 100%; height: 85px; display: flex; background: #0a0a0f; border-top: 2px solid #333; z-index: 200; }
        .nav-btn { flex: 1; border: none; background: none; color: #555; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; }
        .nav-btn.active { color: var(--dia); }
        .nav-btn span { font-size: 1.6rem; margin-bottom: 5px; }

        /* ë²„íŠ¼ */
        .btn { border: none; border-radius: 14px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-main { background: linear-gradient(135deg, #ff416c, #ff4b2b); width: 100%; padding: 18px; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(255,65,108,0.4); }
        .btn-sub { background: var(--gold); color: black; padding: 8px 14px; font-size: 0.8rem; }

        /* íŠ¹ìˆ˜ íš¨ê³¼ */
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.98); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
        #toast { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: var(--ssr); color: #000; padding: 12px 35px; border-radius: 30px; font-weight: bold; z-index: 3000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .hidden { display: none !important; }
        .shake { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(0, 0); } }

        /* ë“±ê¸‰ë³„ ìƒ‰ìƒ */
        .color-sr { color: var(--sr); }
        .color-ssr { color: var(--ssr); }
        .color-mythic { color: var(--mythic); text-shadow: 0 0 10px var(--mythic); }
    </style>
</head>
<body>

<div id="toast">ì•Œë¦¼</div>

<div id="auth-screen" class="overlay">
    <h1 style="color:var(--dia); font-size: 2.5rem; margin-bottom: 0; text-shadow: 0 0 20px var(--dia);">MYTHIC</h1>
    <h2 style="color:white; margin-top: 0; letter-spacing: 8px; font-size: 1rem;">OVERLORD</h2>
    <div style="width:100%; margin-top: 30px;">
        <input type="text" id="user-id" style="width:100%; padding:15px; margin-bottom:10px; background:#111; border:1px solid #333; color:white; border-radius:12px; box-sizing: border-box;" placeholder="ì•„ì´ë””">
        <input type="password" id="user-pw" style="width:100%; padding:15px; margin-bottom:20px; background:#111; border:1px solid #333; color:white; border-radius:12px; box-sizing: border-box;" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn btn-main" onclick="initAudio(); handleAuth();">ìš´ëª…ì— ì ‘ì†í•˜ê¸°</button>
    </div>
    <p style="color:#444; font-size: 0.7rem; margin-top: 20px;">* ì†Œë¦¬ë¥¼ ì¼œê³  í”Œë ˆì´í•˜ì„¸ìš”</p>
</div>

<div id="app" class="hidden">
    <div class="status-bar">
        <div class="stat-card" style="color:var(--dia)">ğŸ’ <span id="val-dia">0</span></div>
        <div class="stat-card" style="color:var(--gold)">ğŸ’° <span id="val-gold">0</span></div>
        <div class="stat-card" style="color:#00ff88">âš”ï¸ <span id="val-dps-top">0</span></div>
    </div>

    <div class="content">
        <div id="tab-battle">
            <div class="battle-view" id="battle-area">
                <div id="king-tag" style="font-size:0.7rem; color:var(--gold); font-weight:bold; display:none; margin-bottom:5px;">âœ¨ WORLD CHAMPION DOMAIN âœ¨</div>
                <div style="font-weight:bold; color:var(--ssr); font-size: 1.1rem;">STAGE <span id="cur-stage">1</span></div>
                <div class="monster-img" id="monster-icon">ğŸ‘¾</div>
                <div class="hp-bar">
                    <div id="hp-fill" class="hp-fill"></div>
                    <div id="hp-text" class="hp-text">100 / 100</div>
                </div>
                <button class="btn btn-main" onmousedown="manualHit()">ì  ì²˜ì¹˜ (CLICK)</button>
                <button id="btn-king-skill" class="btn" style="width:100%; margin-top:10px; height:45px; background:var(--gold); color:black; display:none;" onclick="kingSkill()">ì™•ì˜ ìœ„ì—„ (10ì´ˆê°„ 10ë°° ë°ë¯¸ì§€)</button>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>ğŸº ë³´ìœ  ìœ ë¬¼</h4>
                <small id="arti-bonus-text" style="color:var(--dia); font-size:0.7rem;"></small>
            </div>
            <div id="arti-list" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;"></div>
        </div>

        <div id="tab-draw" class="hidden">
            <h3 style="text-align:center;">ğŸ”® ì°¨ì›ì˜ ë¬¸</h3>
            <div id="draw-area" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:8px; min-height:110px; background:rgba(255,255,255,0.05); padding:15px; border-radius:18px; margin-bottom:20px;"></div>
            <button class="btn btn-main" onclick="summon(10)">10íšŒ ì—°ì† ì†Œí™˜ (1,000ğŸ’)</button>
            <p style="text-align:center; font-size:0.7rem; color:#666; margin-top:10px;">MYTHIC í™•ë¥ : 5% | SSR í™•ë¥ : 15%</p>
        </div>

        <div id="tab-manage" class="hidden">
            <div class="battle-view" style="padding:15px; margin-bottom:15px;">
                <b>ğŸ”¨ ì „ì„¤ ì œë ¨ì†Œ (+<span id="val-wp">0</span>)</b><br>
                <div style="font-size:0.7rem; color:#aaa; margin: 5px 0;">ì„±ê³µ ì‹œ ê³µê²©ë ¥ ë¹„ì•½ì  ìƒìŠ¹! (ì‹¤íŒ¨ ì‹œ í•˜ë½)</div>
                <button class="btn btn-sub" style="width:100%;" onclick="upgrade()">ì œë ¨ ì‹œë„ (2,000ğŸ’°)</button>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4>âš”ï¸ ë‚˜ì˜ êµ°ë‹¨ (<span id="val-inv-count">0</span>)</h4>
                <button class="btn btn-sub" style="background:var(--sr); color:white;" onclick="allEvolve()">ìë™ í•©ì„±</button>
            </div>
            <div id="inv-list"></div>
        </div>

        <div id="tab-book" class="hidden">
            <h3 style="text-align:center;">ğŸ“– ì „ì„¤ ë„ê°</h3>
            <div style="background:rgba(0,242,255,0.1); padding:10px; border-radius:12px; text-align:center; margin-bottom:20px;">
                <span style="font-size:0.8rem;">ë„ê° ë³´ë„ˆìŠ¤: <b id="val-book-bonus" style="color:var(--dia)">+0%</b></span><br>
                <small style="font-size:0.6rem; color:#888;">ë°œê²¬í•œ ì˜ì›… í•œ ì¢…ë¥˜ë‹¹ ì˜êµ¬ ê³µê²©ë ¥ 1% ì¦í­</small>
            </div>
            <div id="book-grid" class="grid-4"></div>
        </div>

        <div id="tab-shop" class="hidden">
            <h3 style="text-align:center;">ğŸ›’ ì œêµ­ ì•”ì‹œì¥</h3>
            <div class="card">
                <div class="card-info"><b>ğŸ’ ë‹¤ì´ì•„ í™˜ì „ì†Œ</b><br><small>8,000ğŸ’° â” 100ğŸ’ (íŠ¹ë³„ í• ì¸)</small></div>
                <button class="btn btn-sub" onclick="exchangeDia()">í™˜ì „</button>
            </div>
            <div class="card">
                <div class="card-info"><b>ğŸ–±ï¸ ì˜¤í†  í´ë¦­ì»¤</b><br><small>30ì´ˆê°„ ì´ˆë‹¹ 10íšŒ ìë™ ê³µê²©</small></div>
                <button class="btn btn-sub" onclick="buyItem('auto', 3000)">3,000ğŸ’°</button>
            </div>
            <div class="card">
                <div class="card-info"><b>ğŸ›¡ï¸ ì œë ¨ ë³´í˜¸ì„</b><br><small>ì œë ¨ ì‹¤íŒ¨ ì‹œ ë“±ê¸‰ í•˜ë½ì„ ë°©ì§€ (ë³´ìœ : <span id="val-prot">0</span>)</small></div>
                <button class="btn btn-sub" onclick="buyItem('prot', 15000)">15,000ğŸ’°</button>
            </div>
            <div class="card">
                <div class="card-info"><b>ğŸ– ê³µê²©ë ¥ ë¬¼ì•½</b><br><small>60ì´ˆê°„ ê³µê²©ë ¥ 2ë°° ì¦í­</small></div>
                <button class="btn btn-sub" onclick="buyItem('atkBuf', 5000)">5,000ğŸ’°</button>
            </div>
        </div>

        <div id="tab-social" class="hidden">
            <h3 style="text-align:center;">ğŸ† ì›”ë“œ ë­í‚¹ (Top 10)</h3>
            <div id="rank-list" class="battle-view" style="text-align:left; padding:15px; font-size:0.9rem;"></div>
            
            <h3 style="text-align:center;">âš”ï¸ íƒ€ ìœ ì € ì•½íƒˆ</h3>
            <div class="card">
                <input type="text" id="search-id" placeholder="ìœ ì € ì•„ì´ë”” ê²€ìƒ‰" style="flex:1; background:none; border:none; color:white; outline:none; font-size:1rem;">
                <button class="btn btn-sub" style="background:var(--mythic); color:white;" onclick="pvp()">ì•½íƒˆí•˜ê¸°</button>
            </div>
            <p id="pvp-res" style="text-align:center; font-size:0.8rem; min-height:1.2rem;"></p>
        </div>
    </div>

    <nav class="nav">
        <button class="nav-btn active" onclick="nav('battle')"><span>âš”ï¸</span>ì „íˆ¬</button>
        <button class="nav-btn" onclick="nav('draw')"><span>ğŸ”®</span>ì†Œí™˜</button>
        <button class="nav-btn" onclick="nav('manage')"><span>ğŸ‘¤</span>êµ°ë‹¨</button>
        <button class="nav-btn" onclick="nav('book')"><span>ğŸ“–</span>ë„ê°</button>
        <button class="nav-btn" onclick="nav('shop')"><span>ğŸ›’</span>ìƒì </button>
        <button class="nav-btn" onclick="nav('social')"><span>ğŸ†</span>ì†Œì…œ</button>
    </nav>
</div>

<script>
    /* --- ì‚¬ìš´ë“œ ì—”ì§„ (Web Audio API) --- */
    let audioCtx;
    function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playSfx(freq, type, dur, vol=0.1) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    /* --- ë°ì´í„° ì •ì˜ --- */
    let currentUser = "";
    let game = {};
    let buffs = { auto: 0, king: 0, atkBuf: 0 };
    
    const HERO_IMGS = { SR: ["âš”ï¸", "ğŸ¹", "ğŸ›¡ï¸", "ğŸ—¡ï¸"], SSR: ["âœ¨", "ğŸ§™", "ğŸ”±", "ğŸ²"], MYTHIC: ["ğŸ‘‘", "ğŸ’", "â˜„ï¸", "ğŸŒ‘"] };
    const HERO_DB = [];
    for(let i=1; i<=40; i++) {
        let g = i > 34 ? "MYTHIC" : (i > 20 ? "SSR" : "SR");
        let pool = HERO_IMGS[g];
        HERO_DB.push({ 
            id: i, 
            name: `${g} ì˜ì›… ${i}`, 
            grade: g, 
            img: pool[i % pool.length], 
            atk: i*120 + (i > 20 ? 8000 : 800), 
            price: 1000 + (i*300) 
        });
    }

    const ARTI_DB = [
        { id: 1, name: "íŒŒë©¸ì˜ ê²€", desc: "ê³µê²©ë ¥ ì¦ê°€", icon: "ğŸ—¡ï¸" },
        { id: 2, name: "í™©ê¸ˆ ì”", desc: "ê³¨ë“œ ë³´ë„ˆìŠ¤", icon: "ğŸ†" },
        { id: 3, name: "ë§ˆë²• ì—´ì‡ ", desc: "ë‹¤ì´ì•„ ë“œë", icon: "ğŸ”‘" }
    ];

    /* --- ì¸ì¦ ì‹œìŠ¤í…œ --- */
    function handleAuth() {
        const id = document.getElementById('user-id').value.trim();
        const pw = document.getElementById('user-pw').value.trim();
        if(!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        const users = JSON.parse(localStorage.getItem('mo_god_users') || "{}");
        if(users[id]) {
            if(users[id].pw !== pw) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            game = users[id].data;
            if(!game.book) game.book = []; // ë„ê° ì´ˆê¸°í™” ëŒ€ì‘
        } else {
            game = { dia: 3000, gold: 0, wp: 0, stage: 1, inv: [], artis: {1:0, 2:0, 3:0}, prot: 0, mHp: 2000, maxHp: 2000, book: [] };
            users[id] = { pw, data: game };
            localStorage.setItem('mo_god_users', JSON.stringify(users));
        }
        currentUser = id;
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        updateUI(); updateMonster();
    }

    function save() {
        if(!currentUser) return;
        const users = JSON.parse(localStorage.getItem('mo_god_users') || "{}");
        users[currentUser].data = game;
        localStorage.setItem('mo_god_users', JSON.stringify(users));
    }

    /* --- ì „íˆ¬ ì‹œìŠ¤í…œ --- */
    function calcAtk() {
        let base = game.inv.reduce((s, h) => s + (h.atk * (h.star || 1)), 0);
        let bookBonus = 1 + (game.book.length * 0.015); // í•œ ë§ˆë¦¬ë‹¹ 1.5%
        let artiBonus = 1 + (game.artis[1] * 0.4); // ë ˆë²¨ë‹¹ 40%
        let total = (base + (game.wp * 1200) + 150) * bookBonus * artiBonus;
        if(buffs.atkBuf > 0) total *= 2;
        return buffs.king > 0 ? total * 10 : total;
    }

    function manualHit() {
        playSfx(180, 'sine', 0.1, 0.2);
        const area = document.getElementById('battle-area');
        area.classList.add('shake');
        setTimeout(() => area.classList.remove('shake'), 100);
        hit(calcAtk());
    }

    function hit(d) {
        game.mHp -= d;
        if(game.mHp <= 0) {
            playSfx(550, 'triangle', 0.2, 0.1);
            let gBonus = 1 + (game.artis[2] * 0.65);
            game.gold += Math.floor((1000 + (game.stage * 300)) * gBonus);
            
            let dChance = 0.2 + (game.artis[3] * 0.1);
            if(Math.random() < dChance) {
                game.dia += 40;
                msg("ğŸ’ ë‹¤ì´ì•„ ë°œê²¬!");
            }

            if(game.stage % 10 === 0) {
                let r = Math.floor(Math.random()*3)+1;
                game.artis[r]++;
                msg(`ğŸº ìœ ë¬¼ ê°•í™” ì„±ê³µ! [${ARTI_DB[r-1].name}] Lv.${game.artis[r]}`);
            }

            game.stage++;
            game.maxHp = Math.floor(2000 * Math.pow(1.4, game.stage-1));
            game.mHp = game.maxHp;
            updateMonster();
        }
        updateUI(); save();
    }

    // ë£¨í”„ ì‹œìŠ¤í…œ
    setInterval(() => {
        hit(calcAtk() / 10); // ì´ˆë‹¹ ìë™ ë°ë¯¸ì§€
        if(buffs.auto > 0) { hit(calcAtk() / 2); buffs.auto -= 0.1; }
        if(buffs.king > 0) buffs.king -= 0.1;
        if(buffs.atkBuf > 0) buffs.atkBuf -= 0.1;
    }, 100);

    /* --- ì†Œí™˜ & êµ°ë‹¨ & ë„ê° --- */
    function summon(n) {
        if(game.dia < 1000) return msg("ë‹¤ì´ì•„ ë¶€ì¡±!");
        game.dia -= 1000;
        playSfx(800, 'sine', 0.5, 0.1);
        const area = document.getElementById('draw-area'); area.innerHTML = '';
        for(let i=0; i<n; i++) {
            let pick = HERO_DB[Math.floor(Math.random()*HERO_DB.length)];
            game.inv.push({...pick, uid: Date.now()+Math.random(), star:1});
            if(!game.book.includes(pick.id)) {
                game.book.push(pick.id);
                msg(`ğŸ“– ë„ê° ë“±ë¡: ${pick.name}!`);
            }
            area.innerHTML += `<div style="font-size:2rem; text-align:center;">${pick.img}</div>`;
        }
        updateUI(); save();
    }

    function renderInv() {
        const list = document.getElementById('inv-list'); list.innerHTML = '';
        game.inv.forEach(h => {
            list.innerHTML += `<div class="card">
                <div class="card-img" style="border-color:var(--${h.grade.toLowerCase()})">${h.img}</div>
                <div class="card-info">
                    <b class="color-${h.grade.toLowerCase()}">${h.name} â˜…${h.star}</b><br>
                    <small>íˆ¬ë ¥: ${(h.atk * h.star).toLocaleString()}</small>
                </div>
                <button class="btn btn-sub" onclick="sellHero(${h.uid})">íŒë§¤</button>
            </div>`;
        });
        document.getElementById('val-inv-count').innerText = game.inv.length;
    }

    function sellHero(uid) {
        let idx = game.inv.findIndex(h => h.uid === uid);
        let h = game.inv[idx];
        game.gold += h.price;
        if(h.grade === "SSR") game.dia += 60;
        if(h.grade === "MYTHIC") game.dia += 250;
        game.inv.splice(idx, 1);
        renderInv(); updateUI(); save();
    }

    function allEvolve() {
        let counts = {};
        game.inv.forEach(h => counts[h.id] = (counts[h.id] || 0) + 1);
        let evolved = false;
        for(let id in counts) {
            if(counts[id] >= 2) {
                let idNum = parseInt(id);
                game.inv.splice(game.inv.findIndex(h => h.id === idNum), 1);
                let i2 = game.inv.findIndex(h => h.id === idNum);
                game.inv[i2].star++;
                game.inv[i2].atk *= 2.5;
                evolved = true; break;
            }
        }
        if(evolved) { playSfx(600, 'triangle', 0.3); msg("í•©ì„± ì„±ê³µ!"); renderInv(); updateUI(); save(); }
        else msg("í•©ì„± ëŒ€ìƒ ì—†ìŒ");
    }

    function renderBook() {
        const grid = document.getElementById('book-grid'); grid.innerHTML = '';
        HERO_DB.forEach(h => {
            const unlocked = game.book.includes(h.id);
            grid.innerHTML += `<div class="book-slot ${unlocked?'active':''}">${h.img}</div>`;
        });
        document.getElementById('val-book-bonus').innerText = `+${(game.book.length * 1.5).toFixed(1)}%`;
    }

    /* --- ìƒì  & ê°•í™” & ì†Œì…œ --- */
    function exchangeDia() { if(game.gold >= 8000) { game.gold -= 8000; game.dia += 100; updateUI(); save(); } else msg("ê³¨ë“œ ë¶€ì¡±!"); }
    function buyItem(t, p) { 
        if(game.gold >= p) { 
            game.gold -= p; 
            if(t==='auto') buffs.auto = 30;
            if(t==='prot') game.prot++;
            if(t==='atkBuf') buffs.atkBuf = 60;
            msg("êµ¬ë§¤ ì™„ë£Œ!"); updateUI(); save(); 
        } else msg("ê³¨ë“œ ë¶€ì¡±!");
    }

    function upgrade() {
        if(game.gold < 2000) return msg("ê³¨ë“œ ë¶€ì¡±!");
        game.gold -= 2000;
        if(Math.random() < 0.35) {
            game.wp++;
            playSfx(1000, 'sine', 0.2, 0.1);
            msg("ğŸ”¨ ì œë ¨ ì„±ê³µ! íŒŒì›Œ ì—…!");
        } else {
            if(game.prot > 0) { game.prot--; msg("ğŸ›¡ï¸ ë³´í˜¸ì„ ì†Œëª¨! ë“±ê¸‰ ìœ ì§€."); }
            else { game.wp = Math.max(0, game.wp - 1); msg("ğŸ’¨ ì œë ¨ ì‹¤íŒ¨..."); }
        }
        updateUI(); save();
    }

    function pvp() {
        const sid = document.getElementById('search-id').value.trim();
        const users = JSON.parse(localStorage.getItem('mo_god_users') || "{}");
        if(!users[sid] || sid === currentUser) return msg("ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŒ");

        let myP = calcAtk();
        // íƒ€ ìœ ì € ë°ë¯¸ì§€ëŠ” ê°„ëµ ê³„ì‚°
        let opP = users[sid].data.inv.reduce((s, h) => s + (h.atk * h.star), 0) + (users[sid].data.wp * 1200);

        if(myP > opP) {
            let steal = Math.floor(users[sid].data.gold * 0.2);
            game.gold += steal; users[sid].data.gold -= steal;
            localStorage.setItem('mo_god_users', JSON.stringify(users));
            document.getElementById('pvp-res').innerText = `âš”ï¸ ì•½íƒˆ ì„±ê³µ! ${steal.toLocaleString()}ğŸ’° ê°•íƒˆ!`;
            document.getElementById('pvp-res').style.color = "var(--dia)";
        } else {
            document.getElementById('pvp-res').innerText = `ğŸ’€ ì•½íƒˆ íŒ¨ë°°... ì—­ê³µì„ ë‹¹í–ˆìŠµë‹ˆë‹¤.`;
            document.getElementById('pvp-res').style.color = "var(--mythic)";
        }
        updateUI(); save();
    }

    /* --- UI ì—”ì§„ --- */
    function nav(t) {
        document.querySelectorAll('.content > div').forEach(d => d.classList.add('hidden'));
        document.getElementById('tab-' + t).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(t === 'manage') renderInv();
        if(t === 'book') renderBook();
        if(t === 'social') updateRank();
        if(t === 'battle') renderArtis();
    }

    function updateRank() {
        const users = JSON.parse(localStorage.getItem('mo_god_users') || "{}");
        let list = Object.keys(users).map(id => ({ id, stage: users[id].data.stage }));
        list.sort((a, b) => b.stage - a.stage);
        
        document.getElementById('rank-list').innerHTML = list.slice(0, 10).map((u, i) => `
            <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #333; ${u.id===currentUser?'background:rgba(0,242,255,0.05);':''}">
                <span>${i===0?'ğŸ‘‘':(i+1)+'.'} <b>${u.id}</b> ${i===0?'[KING]':''}</span>
                <span style="color:var(--gold)">Stage ${u.stage}</span>
            </div>`).join('');

        const isKing = (list.length > 0 && list[0].id === currentUser);
        document.getElementById('battle-area').classList.toggle('king-mode', isKing);
        document.getElementById('king-tag').style.display = isKing ? 'block' : 'none';
        document.getElementById('btn-king-skill').style.display = isKing ? 'block' : 'none';
    }

    function renderArtis() {
        const area = document.getElementById('arti-list'); area.innerHTML = '';
        ARTI_DB.forEach(a => {
            area.innerHTML += `<div style="background:#111; padding:12px; border-radius:15px; border:1px solid #333; text-align:center;">
                <div style="font-size:1.8rem;">${a.icon}</div>
                <b style="font-size:0.8rem; color:var(--ssr);">Lv.${game.artis[a.id]}</b><br>
                <small style="font-size:0.55rem; color:#666;">${a.desc}</small>
            </div>`;
        });
        document.getElementById('arti-bonus-text').innerText = `ë°ë¯¸ì§€ +${game.artis[1]*40}% / ê³¨ë“œ +${game.artis[2]*65}%`;
    }

    function kingSkill() {
        if(buffs.king > 0) return;
        buffs.king = 10;
        playSfx(900, 'sawtooth', 0.5, 0.1);
        msg("ğŸ‘‘ ì™•ì˜ ìœ„ì—„ ë°œë™! ë°ë¯¸ì§€ 10ë°° í­ì¦!");
    }

    function msg(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 1500); }
    function updateMonster() { document.getElementById('monster-icon').innerText = ["ğŸ‘¾", "ğŸ‰", "ğŸ§›", "ğŸ§Ÿ", "ğŸ™", "ğŸ¦–", "ğŸ‘¹", "ğŸ¦‡"][game.stage % 8]; }
    function updateUI() {
        document.getElementById('val-dia').innerText = Math.floor(game.dia).toLocaleString();
        document.getElementById('val-gold').innerText = Math.floor(game.gold).toLocaleString();
        document.getElementById('val-dps-top').innerText = Math.floor(calcAtk()).toLocaleString();
        document.getElementById('val-dps').innerText = Math.floor(calcAtk()).toLocaleString();
        document.getElementById('cur-stage').innerText = game.stage;
        document.getElementById('val-wp').innerText = game.wp;
        document.getElementById('val-prot').innerText = game.prot;
        document.getElementById('hp-fill').style.width = (game.mHp / game.maxHp * 100) + '%';
        document.getElementById('hp-text').innerText = `${Math.floor(game.mHp).toLocaleString()} / ${game.maxHp.toLocaleString()}`;
    }
</script>
</body>
</html>
