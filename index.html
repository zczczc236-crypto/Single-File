<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-select=none">
    <title>Mythic Overlord: Final</title>
    <style>
        :root {
            --mythic: #ff4757; --ssr: #ffa502; --sr: #7ed6df; --bg: #0a0a12;
            --gold: #ffd700; --dia: #00d2ff; --panel: rgba(255, 255, 255, 0.05);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        
        #app { width: 100%; max-width: 480px; height: 100%; display: flex; flex-direction: column; background: radial-gradient(circle at top, #1e1e30 0%, #0a0a12 100%); position: relative; border-left: 1px solid #333; border-right: 1px solid #333; }

        /* ìƒë‹¨ ì •ë³´ì°½ */
        .header { padding: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: rgba(0,0,0,0.8); border-bottom: 2px solid #333; z-index: 10; }
        .stat-box { background: var(--panel); padding: 8px; border-radius: 10px; text-align: center; border: 1px solid #444; }
        .stat-box div { font-size: 0.7rem; color: #aaa; margin-bottom: 2px; }
        .stat-box span { font-size: 0.9rem; font-weight: bold; }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; scrollbar-width: none; }
        .main-content::-webkit-scrollbar { display: none; }

        /* ì „íˆ¬ UI */
        .battle-stage { background: var(--panel); border-radius: 25px; border: 2px solid #444; padding: 30px 20px; text-align: center; position: relative; margin-bottom: 25px; transition: 0.1s; }
        .monster-box { font-size: 6rem; height: 150px; display: flex; align-items: center; justify-content: center; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2)); margin: 10px 0; }
        .hp-container { height: 20px; background: #222; border-radius: 10px; border: 1px solid #555; overflow: hidden; position: relative; margin: 15px 0; }
        .hp-bar { height: 100%; background: linear-gradient(90deg, #ff4757, #ff6b81); width: 100%; transition: 0.2s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        .hp-text { position: absolute; width: 100%; text-align: center; font-size: 0.7rem; line-height: 20px; font-weight: bold; text-shadow: 1px 1px 2px black; }

        /* ì˜ì›… & ì•„ì´í…œ ì¹´ë“œ */
        .card { background: var(--panel); border: 1px solid #333; border-radius: 15px; padding: 12px; display: flex; align-items: center; margin-bottom: 12px; transition: transform 0.1s; }
        .card:active { transform: scale(0.97); }
        .hero-icon { width: 55px; height: 55px; border-radius: 12px; background: #1a1a1a; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-right: 15px; border: 2px solid #444; }
        .hero-info { flex: 1; }
        .hero-info b { font-size: 1rem; display: block; }
        .hero-info small { color: #888; font-size: 0.75rem; }

        /* ë„ê° ê·¸ë¦¬ë“œ */
        .book-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .book-item { aspect-ratio: 1; background: #111; border-radius: 12px; border: 1px solid #222; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; filter: grayscale(1); opacity: 0.2; }
        .book-item.active { filter: grayscale(0); opacity: 1; border-color: var(--ssr); box-shadow: 0 0 10px rgba(255,165,2,0.3); }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .nav { position: absolute; bottom: 0; width: 100%; height: 80px; background: #05050a; display: flex; border-top: 2px solid #333; padding: 5px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #555; font-size: 0.7rem; font-weight: bold; }
        .nav-item.active { color: var(--dia); }
        .nav-item i { font-style: normal; font-size: 1.5rem; margin-bottom: 4px; }

        /* ë²„íŠ¼ë¥˜ */
        .btn { border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-hit { width: 100%; padding: 18px; font-size: 1.2rem; background: linear-gradient(135deg, #ff416c, #ff4b2b); box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4); }
        .btn-buy { background: var(--gold); color: black; padding: 8px 15px; font-size: 0.8rem; }
        .btn-sm { padding: 5px 10px; font-size: 0.7rem; background: #444; }

        /* ê¸°íƒ€ */
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
        #toast { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: var(--dia); color: black; padding: 12px 25px; border-radius: 25px; font-weight: bold; opacity: 0; transition: 0.3s; z-index: 2000; pointer-events: none; }
        .hidden { display: none !important; }
        .shake { animation: shake 0.1s; }
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(3px, 3px); } 75% { transform: translate(-3px, -3px); } }
        
        .mythic-border { border-color: var(--mythic) !important; box-shadow: 0 0 15px var(--mythic); }
        .ssr-border { border-color: var(--ssr) !important; }
    </style>
</head>
<body>

<div id="toast">ë©”ì‹œì§€</div>

<div id="auth-screen" class="overlay">
    <h1 style="color:var(--dia); font-size: 2.2rem; margin-bottom: 5px;">MYTHIC OVERLORD</h1>
    <p style="color:#777; font-size: 0.9rem; margin-bottom: 30px;">ë‹¹ì‹ ì˜ ì˜ê´‘ì„ ì¦ëª…í•˜ì‹­ì‹œì˜¤</p>
    <div style="width: 100%;">
        <input type="text" id="join-id" style="width:100%; padding:15px; background:#111; border:1px solid #444; color:white; border-radius:12px; margin-bottom:10px;" placeholder="ì˜ì£¼ ì•„ì´ë””">
        <input type="password" id="join-pw" style="width:100%; padding:15px; background:#111; border:1px solid #444; color:white; border-radius:12px; margin-bottom:20px;" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn btn-hit" onclick="handleAuth()">ì œêµ­ ì ‘ì†</button>
    </div>
</div>

<div id="app" class="hidden">
    <header class="header">
        <div class="stat-box"><div>ğŸ’° ê³¨ë“œ</div><span id="txt-gold" style="color:var(--gold)">0</span></div>
        <div class="stat-box"><div>ğŸ’ ë‹¤ì´ì•„</div><span id="txt-dia" style="color:var(--dia)">0</span></div>
        <div class="stat-box"><div>âš”ï¸ íˆ¬ë ¥</div><span id="txt-atk" style="color:#00ff88">0</span></div>
    </header>

    <div class="main-content">
        <div id="tab-battle">
            <div class="battle-stage" id="stage-box">
                <div id="king-label" style="display:none; color:var(--gold); font-size:0.7rem; font-weight:bold; margin-bottom:5px;">ğŸ‘‘ WORLD CHAMPION AREA</div>
                <div style="color:var(--ssr); font-weight:bold;">STAGE <span id="txt-stage">1</span></div>
                <div class="monster-box" id="monster-icon">ğŸ‘¾</div>
                <div class="hp-container">
                    <div id="hp-bar" class="hp-bar"></div>
                    <div id="hp-text" class="hp-text">0 / 0</div>
                </div>
                <button class="btn btn-hit" onmousedown="clickAttack()">ê³µê²© ê°œì‹œ</button>
                <button id="btn-king" class="btn" style="width:100%; margin-top:10px; height:45px; background:var(--gold); color:black; display:none;" onclick="useKingSkill()">ì™•ì˜ ìœ„ì—„ (10ë°° ë°ë¯¸ì§€)</button>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0;">ğŸº í™œì„±í™”ëœ ìœ ë¬¼</h4>
                <small id="txt-arti-info" style="color:#888; font-size:0.65rem;"></small>
            </div>
            <div id="list-artis" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;"></div>
        </div>

        <div id="tab-draw" class="hidden">
            <h3 style="text-align:center;">ğŸ”® ì˜ì›… ì†Œí™˜</h3>
            <div id="draw-result" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; background:rgba(255,255,255,0.03); padding:15px; border-radius:20px; min-height:120px; margin-bottom:20px;"></div>
            <button class="btn btn-hit" onclick="summonHeroes(10)">10íšŒ ì†Œí™˜ (1,000ğŸ’)</button>
            <div style="margin-top:20px; padding:15px; background:var(--panel); border-radius:15px; font-size:0.8rem; color:#aaa;">
                <p style="margin:5px 0;">â€¢ MYTHIC ì˜ì›…: 5% í™•ë¥ </p>
                <p style="margin:5px 0;">â€¢ SSR ì˜ì›…: 15% í™•ë¥ </p>
                <p style="margin:5px 0;">â€¢ ë™ì¼ ì˜ì›… íšë“ ì‹œ ë„ê° ë³´ë„ˆìŠ¤ ê°•í™”</p>
            </div>
        </div>

        <div id="tab-hero" class="hidden">
            <div class="card" style="background:rgba(0,210,255,0.05); border:1px dashed var(--dia);">
                <div class="hero-info">
                    <b>ğŸ”¨ ì „ì„¤ ì œë ¨ì†Œ (+<span id="txt-wp">0</span>)</b>
                    <small>ì„±ê³µë¥  35% | ì‹¤íŒ¨ ì‹œ ë“±ê¸‰ í•˜ë½ (ë³´í˜¸ì„ìœ¼ë¡œ ë°©ì§€)</small>
                </div>
                <button class="btn btn-buy" onclick="refineWeapon()">ì œë ¨ (2,000ğŸ’°)</button>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4 style="margin:0;">âš”ï¸ ë‚˜ì˜ ì˜ì›…ë“¤ (<span id="txt-hero-cnt">0</span>)</h4>
                <button class="btn btn-sm" onclick="autoEvolve()" style="background:var(--sr); color:black;">ì¼ê´„ í•©ì„±</button>
            </div>
            <div id="list-heroes"></div>
        </div>

        <div id="tab-book" class="hidden">
            <h3 style="text-align:center;">ğŸ“– ì œêµ­ ë„ê°</h3>
            <div style="background:var(--panel); padding:15px; border-radius:15px; text-align:center; margin-bottom:20px;">
                <div style="font-size:0.8rem; color:#ccc;">í˜„ì¬ ìˆ˜ì§‘ ë³´ë„ˆìŠ¤</div>
                <div style="font-size:1.5rem; font-weight:bold; color:var(--dia);" id="txt-book-bonus">+0%</div>
                <small style="color:#666;">ìˆ˜ì§‘ëœ ì˜ì›… í•œ ì¢…ë¥˜ë‹¹ ì˜êµ¬ ê³µê²©ë ¥ 2% ìƒìŠ¹</small>
            </div>
            <div id="grid-book" class="book-grid"></div>
        </div>

        <div id="tab-social" class="hidden">
            <h3 style="text-align:center;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3>
            <div id="list-rank" style="background:var(--panel); border-radius:20px; padding:10px; margin-bottom:25px;"></div>
            
            <h3 style="text-align:center;">âš”ï¸ ì•„ì´ë”” ì•½íƒˆ</h3>
            <div class="card">
                <input type="text" id="target-id" style="flex:1; background:none; border:none; color:white; outline:none;" placeholder="ì•½íƒˆí•  ìœ ì € ID">
                <button class="btn btn-buy" style="background:var(--mythic); color:white;" onclick="startPvp()">ê³µê²©</button>
            </div>
            <div id="pvp-log" style="text-align:center; font-size:0.8rem; margin-top:10px;"></div>
        </div>

        <div id="tab-shop" class="hidden">
            <h3 style="text-align:center;">ğŸ›’ ì œêµ­ ìƒì </h3>
            <div class="card">
                <div class="hero-info"><b>ğŸ’ ë‹¤ì´ì•„ í™˜ì „</b><small>8,000ğŸ’° â” 100ğŸ’</small></div>
                <button class="btn btn-buy" onclick="buyShop('dia')">í™˜ì „</button>
            </div>
            <div class="card">
                <div class="hero-info"><b>ğŸ–±ï¸ ì˜¤í†  í´ë¦­</b><small>30ì´ˆê°„ ìë™ ê³µê²© (ë³´ìœ : <span id="txt-buff-auto">0</span>ì´ˆ)</small></div>
                <button class="btn btn-buy" onclick="buyShop('auto')">3,000ğŸ’°</button>
            </div>
            <div class="card">
                <div class="hero-info"><b>ğŸ›¡ï¸ ì œë ¨ ë³´í˜¸ì„</b><small>ì‹¤íŒ¨ ì‹œ ë“±ê¸‰ í•˜ë½ ë°©ì§€ (ë³´ìœ : <span id="txt-prot">0</span>ê°œ)</small></div>
                <button class="btn btn-buy" onclick="buyShop('prot')">15,000ğŸ’°</button>
            </div>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="changeTab('battle')"><i>âš”ï¸</i>ì „íˆ¬</div>
        <div class="nav-item" onclick="changeTab('draw')"><i>ğŸ”®</i>ì†Œí™˜</div>
        <div class="nav-item" onclick="changeTab('hero')"><i>ğŸ‘¤</i>êµ°ë‹¨</div>
        <div class="nav-item" onclick="changeTab('book')"><i>ğŸ“–</i>ë„ê°</div>
        <div class="nav-item" onclick="changeTab('social')"><i>ğŸ†</i>ì†Œì…œ</div>
        <div class="nav-item" onclick="changeTab('shop')"><i>ğŸ›’</i>ìƒì </div>
    </nav>
</div>

<script>
    /* --- ì‚¬ìš´ë“œ ì»¨íŠ¸ë¡¤ëŸ¬ (Web Audio API) --- */
    let audioCtx = null;
    function playSound(freq, type, dur, vol = 0.1) {
        if (!audioCtx) return;
        try {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + dur);
        } catch(e) {}
    }

    /* --- ê²Œì„ ë°ì´í„° --- */
    let user = "";
    let data = {
        gold: 0, dia: 3000, stage: 1, wp: 0, prot: 0,
        inv: [], book: [], artis: { 1:0, 2:0, 3:0 },
        mHp: 2000, maxHp: 2000
    };
    let buffs = { auto: 0, king: 0 };

    const HERO_LIST = [];
    const ICONS = { SR: ["ğŸ¹", "ğŸ›¡ï¸", "ğŸ—¡ï¸", "âš”ï¸"], SSR: ["ğŸ§™", "ğŸ”±", "ğŸ²", "âœ¨"], MYTHIC: ["ğŸ‘‘", "ğŸ’", "â˜„ï¸", "ğŸŒ‘"] };
    for(let i=1; i<=40; i++) {
        let g = i > 35 ? "MYTHIC" : (i > 20 ? "SSR" : "SR");
        HERO_LIST.push({ id: i, name: `ì˜ì›… No.${i}`, grade: g, img: ICONS[g][i % 4], atk: i * 150 + (i > 20 ? 5000 : 500), price: 1000 + (i * 200) });
    }

    /* --- ì‹œìŠ¤í…œ ë¡œì§ --- */
    function handleAuth() {
        const id = document.getElementById('join-id').value.trim();
        const pw = document.getElementById('join-pw').value.trim();
        if(!id || !pw) return alert("ì…ë ¥ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");

        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ í™œì„±í™” (ë¸Œë¼ìš°ì € ì •ì±… ëŒ€ì‘)
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const db = JSON.parse(localStorage.getItem('mythic_v3_db') || "{}");
        if(db[id]) {
            if(db[id].pw !== pw) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤.");
            data = {...data, ...db[id].data};
        } else {
            db[id] = { pw: pw, data: data };
            localStorage.setItem('mythic_v3_db', JSON.stringify(db));
        }
        user = id;
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        updateUI();
        updateMonster();
        startLoops();
    }

    function saveGame() {
        if(!user) return;
        const db = JSON.parse(localStorage.getItem('mythic_v3_db') || "{}");
        db[user].data = data;
        localStorage.setItem('mythic_v3_db', JSON.stringify(db));
    }

    function getAtk() {
        let baseAtk = data.inv.reduce((sum, h) => sum + (h.atk * h.star), 0);
        let bookMul = 1 + (data.book.length * 0.02);
        let artiMul = 1 + (data.artis[1] * 0.4);
        let finalAtk = (baseAtk + (data.wp * 1500) + 100) * bookMul * artiMul;
        return buffs.king > 0 ? finalAtk * 10 : finalAtk;
    }

    function clickAttack() {
        playSound(200, 'sine', 0.1, 0.2);
        const box = document.getElementById('stage-box');
        box.classList.add('shake');
        setTimeout(() => box.classList.remove('shake'), 100);
        doDamage(getAtk());
    }

    function doDamage(dmg) {
        data.mHp -= dmg;
        if(data.mHp <= 0) {
            playSound(500, 'triangle', 0.2);
            let goldMul = 1 + (data.artis[2] * 0.7);
            data.gold += Math.floor((1000 + (data.stage * 400)) * goldMul);
            
            if(Math.random() < (0.2 + data.artis[3] * 0.1)) {
                data.dia += 50;
                showToast("ğŸ’ ë‹¤ì´ì•„ íšë“!");
            }

            if(data.stage % 10 === 0) {
                let r = Math.floor(Math.random() * 3) + 1;
                data.artis[r]++;
                showToast(`ğŸº ìœ ë¬¼ ê³µëª…! Lv.${data.artis[r]}`);
            }

            data.stage++;
            data.maxHp = Math.floor(2000 * Math.pow(1.35, data.stage - 1));
            data.mHp = data.maxHp;
            updateMonster();
        }
        updateUI();
    }

    function startLoops() {
        setInterval(() => {
            doDamage(getAtk() / 10);
            if(buffs.auto > 0) { doDamage(getAtk() / 3); buffs.auto = Math.max(0, buffs.auto - 0.1); }
            if(buffs.king > 0) buffs.king = Math.max(0, buffs.king - 0.1);
            if(data.stage % 1 === 0) saveGame(); 
        }, 100);
    }

    /* --- íƒ­ ê¸°ëŠ¥ --- */
    function changeTab(tab) {
        document.querySelectorAll('.main-content > div').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        if(tab === 'hero') renderHeroes();
        if(tab === 'book') renderBook();
        if(tab === 'social') renderRank();
        if(tab === 'battle') renderArtis();
        updateUI();
    }

    /* --- ì„¸ë¶€ ê¸°ëŠ¥ --- */
    function summonHeroes(n) {
        if(data.dia < 1000) return showToast("ë‹¤ì´ì•„ ë¶€ì¡±!");
        data.dia -= 1000;
        playSound(800, 'sine', 0.5);
        const area = document.getElementById('draw-result');
        area.innerHTML = '';
        for(let i=0; i<n; i++) {
            let pick = HERO_LIST[Math.floor(Math.random() * HERO_LIST.length)];
            data.inv.push({...pick, uid: Date.now() + Math.random(), star: 1});
            if(!data.book.includes(pick.id)) data.book.push(pick.id);
            area.innerHTML += `<div style="font-size:2rem; text-align:center;">${pick.img}</div>`;
        }
        updateUI();
    }

    function renderHeroes() {
        const list = document.getElementById('list-heroes');
        list.innerHTML = '';
        data.inv.sort((a,b) => b.atk * b.star - a.atk * a.star).forEach(h => {
            list.innerHTML += `
                <div class="card ${h.grade === 'MYTHIC' ? 'mythic-border' : (h.grade === 'SSR' ? 'ssr-border' : '')}">
                    <div class="hero-icon">${h.img}</div>
                    <div class="hero-info">
                        <b style="color:var(--${h.grade.toLowerCase()})">${h.name} [â˜…${h.star}]</b>
                        <small>ì „íˆ¬ë ¥: ${Math.floor(h.atk * h.star).toLocaleString()}</small>
                    </div>
                    <button class="btn btn-sm" onclick="sellHero(${h.uid})">íŒë§¤</button>
                </div>`;
        });
        document.getElementById('txt-hero-cnt').innerText = data.inv.length;
        document.getElementById('txt-wp').innerText = data.wp;
        document.getElementById('txt-prot').innerText = data.prot;
    }

    function sellHero(uid) {
        const idx = data.inv.findIndex(h => h.uid === uid);
        const h = data.inv[idx];
        data.gold += h.price;
        if(h.grade === 'SSR') data.dia += 80;
        if(h.grade === 'MYTHIC') data.dia += 300;
        data.inv.splice(idx, 1);
        renderHeroes();
        updateUI();
    }

    function autoEvolve() {
        let map = {};
        data.inv.forEach(h => { if(!map[h.id]) map[h.id] = []; map[h.id].push(h); });
        let count = 0;
        for(let id in map) {
            while(map[id].length >= 2) {
                let h1 = map[id].pop();
                let h2 = map[id].pop();
                h1.star++;
                h1.atk *= 2.2;
                data.inv = data.inv.filter(x => x.uid !== h2.uid);
                count++;
            }
        }
        if(count > 0) { showToast(`${count}íšŒ í•©ì„± ì™„ë£Œ!`); playSound(600, 'triangle', 0.3); renderHeroes(); updateUI(); }
        else showToast("í•©ì„±í•  ì˜ì›…ì´ ì—†ìŠµë‹ˆë‹¤.");
    }

    function refineWeapon() {
        if(data.gold < 2000) return showToast("ê³¨ë“œ ë¶€ì¡±!");
        data.gold -= 2000;
        if(Math.random() < 0.35) {
            data.wp++;
            playSound(1000, 'sine', 0.2);
            showToast("ğŸ”¨ ì œë ¨ ì„±ê³µ!");
        } else {
            if(data.prot > 0) { data.prot--; showToast("ğŸ›¡ï¸ ë³´í˜¸ì„ìœ¼ë¡œ í•˜ë½ ë°©ì§€!"); }
            else { data.wp = Math.max(0, data.wp - 1); showToast("ğŸ’¨ ì œë ¨ ì‹¤íŒ¨..."); }
        }
        renderHeroes();
        updateUI();
    }

    function renderBook() {
        const grid = document.getElementById('grid-book');
        grid.innerHTML = '';
        HERO_LIST.forEach(h => {
            const active = data.book.includes(h.id);
            grid.innerHTML += `<div class="book-item ${active?'active':''}">${h.img}</div>`;
        });
        document.getElementById('txt-book-bonus').innerText = `+${data.book.length * 2}%`;
    }

    function renderRank() {
        const db = JSON.parse(localStorage.getItem('mythic_v3_db') || "{}");
        let ranks = Object.keys(db).map(id => ({ id, stage: db[id].data.stage }));
        ranks.sort((a,b) => b.stage - a.stage);
        
        const list = document.getElementById('list-rank');
        list.innerHTML = ranks.slice(0, 10).map((u, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333; ${u.id===user?'color:var(--dia)':''}">
                <span>${i===0?'ğŸ‘‘':i+1+'.'} <b>${u.id}</b></span>
                <span>Stage ${u.stage}</span>
            </div>`).join('');
        
        const isKing = ranks.length > 0 && ranks[0].id === user;
        document.getElementById('king-label').style.display = isKing ? 'block' : 'none';
        document.getElementById('btn-king').style.display = isKing ? 'block' : 'none';
    }

    function startPvp() {
        const target = document.getElementById('target-id').value.trim();
        const db = JSON.parse(localStorage.getItem('mythic_v3_db') || "{}");
        if(!db[target] || target === user) return showToast("ëŒ€ìƒ ë¶ˆê°€");
        
        let myAtk = getAtk();
        let opAtk = db[target].data.stage * 10000; // ê°„ëµ ìˆ˜ì¹˜

        if(myAtk > opAtk) {
            let steal = Math.floor(db[target].data.gold * 0.15);
            data.gold += steal;
            db[target].data.gold -= steal;
            localStorage.setItem('mythic_v3_db', JSON.stringify(db));
            document.getElementById('pvp-log').innerText = `âš”ï¸ ìŠ¹ë¦¬! ${steal.toLocaleString()}ê³¨ë“œ ì•½íƒˆ`;
            document.getElementById('pvp-log').style.color = "var(--dia)";
        } else {
            document.getElementById('pvp-log').innerText = `ğŸ’€ íŒ¨ë°°... ë„ë§ì³¤ìŠµë‹ˆë‹¤.`;
            document.getElementById('pvp-log').style.color = "var(--mythic)";
        }
        updateUI();
    }

    function buyShop(type) {
        if(type === 'dia' && data.gold >= 8000) { data.gold -= 8000; data.dia += 100; showToast("í™˜ì „ ì™„ë£Œ"); }
        else if(type === 'auto' && data.gold >= 3000) { data.gold -= 3000; buffs.auto += 30; showToast("ì˜¤í†  30ì´ˆ ì¶”ê°€"); }
        else if(type === 'prot' && data.gold >= 15000) { data.gold -= 15000; data.prot++; showToast("ë³´í˜¸ì„ íšë“"); }
        else showToast("ê³¨ë“œ ë¶€ì¡±");
        updateUI();
    }

    function renderArtis() {
        const area = document.getElementById('list-artis');
        area.innerHTML = '';
        [1,2,3].forEach(i => {
            area.innerHTML += `
                <div style="background:#111; padding:10px; border-radius:12px; text-align:center; border:1px solid #333;">
                    <div style="font-size:1.5rem;">${["", "ğŸ—¡ï¸", "ğŸ†", "ğŸ”‘"][i]}</div>
                    <b style="color:var(--ssr);">Lv.${data.artis[i]}</b>
                </div>`;
        });
        document.getElementById('txt-arti-info').innerText = `ê³µê²© +${data.artis[1]*40}% / ê³¨ë“œ +${data.artis[2]*70}%`;
    }

    function useKingSkill() { buffs.king = 10; showToast("ğŸ‘‘ ì™•ì˜ ìœ„ì—„! ë°ë¯¸ì§€ 10ë°°!"); }
    function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; setTimeout(()=>t.style.opacity=0, 1500); }
    function updateMonster() { document.getElementById('monster-icon').innerText = ["ğŸ‘¾", "ğŸ‰", "ğŸ§Ÿ", "ğŸ§›", "ğŸ‘¹", "ğŸ¦‡", "ğŸ™"][data.stage % 7]; }
    function updateUI() {
        document.getElementById('txt-gold').innerText = Math.floor(data.gold).toLocaleString();
        document.getElementById('txt-dia').innerText = Math.floor(data.dia).toLocaleString();
        document.getElementById('txt-atk').innerText = Math.floor(getAtk()).toLocaleString();
        document.getElementById('txt-stage').innerText = data.stage;
        document.getElementById('txt-buff-auto').innerText = Math.ceil(buffs.auto);
        
        const hpPer = (data.mHp / data.maxHp) * 100;
        document.getElementById('hp-bar').style.width = hpPer + "%";
        document.getElementById('hp-text').innerText = `${Math.floor(data.mHp).toLocaleString()} / ${data.maxHp.toLocaleString()}`;
    }
</script>
</body>
</html>
